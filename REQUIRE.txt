Ã TÆ¯á»NG Cá»T LÃ•I Cáº¦N ÃP Dá»¤NG

Há»‡ thá»‘ng chá»‰ cÃ³ 1 DATABASE LOGIC duy nháº¥t
nhÆ°ng cháº¡y trÃªn nhiá»u mÃ¡y cÃ³ kháº£ nÄƒng thay tháº¿ nhau.

Má»¥c tiÃªu:

âŒ KhÃ´ng trÃ¹ng session xe

âŒ KhÃ´ng dá»«ng barrier khi 1 mÃ¡y há»ng

âœ… Äá»•i mÃ¡y lÃ  cháº¡y tiáº¿p

âœ… Dá»¯ liá»‡u luÃ´n Ä‘á»“ng bá»™

ğŸ§  Kiáº¿n trÃºc tá»•ng thá»ƒ (Ã¡p dá»¥ng cho project cá»§a báº¡n)
3 mÃ¡y giá»‘ng nhau hoÃ n toÃ n
MÃ¡y A â€” Gate IN
MÃ¡y B â€” Gate OUT (Primary DB)
MÃ¡y C â€” Accountant / Backup

ğŸ‘‰ Cáº£ 3 mÃ¡y Ä‘á»u:

cÃ i Laravel

cÃ i SQL Server

cáº¥u hÃ¬nh giá»‘ng nhau

KHÃ”NG cÃ³ mÃ¡y â€œÄ‘áº·c biá»‡tâ€.

Database hoáº¡t Ä‘á»™ng theo mÃ´ hÃ¬nh
           ACTIVE DB
              B
          /         \
        SYNC       SYNC
        A            C

B Ä‘ang lÃ  Primary (ghi dá»¯ liá»‡u)

A vÃ  C nháº­n sync realtime

Khi B há»ng

Admin chá»‰ cáº§n:

Promote A hoáº·c C â†’ ACTIVE

KhÃ´ng cáº§n sá»­a code.

âœ… NguyÃªn táº¯c CODE QUAN TRá»ŒNG (PHáº¦N NÃ€Y LÃ€ Cá»T LÃ•I)
1ï¸âƒ£ á»¨ng dá»¥ng KHÃ”NG connect vÃ o IP mÃ¡y

âŒ Sai:

DB_HOST=192.168.1.12

âœ… ÄÃºng:

DB_HOST=parking-db

ğŸ‘‰ parking-db lÃ  hostname hoáº·c virtual IP.

Sau nÃ y chá»‰ Ä‘á»•i trá» DNS â†’ há»‡ thá»‘ng cháº¡y tiáº¿p.

2ï¸âƒ£ Session xe pháº£i UNIQUE toÃ n há»‡ thá»‘ng

ÄÃ¢y lÃ  chá»— 90% dev bÃ£i xe lÃ m sai.

Table parking_transactions
id
ticket_code (UNIQUE)
plate_number
time_in
time_out
status
Khi xe vÃ o

KHÃ”NG táº¡o session kiá»ƒu:

insert new row

mÃ¹ quÃ¡ng.

Pháº£i dÃ¹ng logic:
BEGIN TRANSACTION

IF NOT EXISTS (
   SELECT 1
   FROM parking_transactions
   WHERE plate_number = ?
   AND status = 'IN'
)
   INSERT SESSION

COMMIT

ğŸ‘‰ SQL lock Ä‘áº£m báº£o 2 barrier khÃ´ng táº¡o trÃ¹ng.

3ï¸âƒ£ Barrier IN vÃ  OUT Ä‘á»u ghi chung DB

Luá»“ng tháº­t:

Camera â†’ Laravel API â†’ SQL PRIMARY
                        â†“
                 Sync sang A,C

KhÃ´ng cÃ³ DB riÃªng tá»«ng mÃ¡y.

4ï¸âƒ£ Gate hoáº¡t Ä‘á»™ng qua API (KHÃ”NG ghi DB trá»±c tiáº¿p)

Thiáº¿t káº¿ chuáº©n:

Gate Software
     â†“
POST /api/vehicle-in
POST /api/vehicle-out
     â†“
Laravel xá»­ lÃ½ transaction
     â†“
SQL Server

ğŸ‘‰ Logic táº­p trung â†’ khÃ´ng trÃ¹ng dá»¯ liá»‡u.

5ï¸âƒ£ Báº¯t buá»™c dÃ¹ng Transaction + Lock

Laravel:

DB::transaction(function () {

   $session = ParkingTransaction::where(
        'plate_number',$plate
   )->lockForUpdate()->first();

});

ğŸ”¥ ÄÃ¢y lÃ  chÃ¬a khÃ³a chá»‘ng double scan.

âœ… Failover mindset trong code

á»¨ng dá»¥ng KHÃ”NG cáº§n biáº¿t mÃ¡y nÃ o lÃ  DB.

Laravel chá»‰ cáº§n:

.env
DB_HOST=parking-db

Khi DB Ä‘á»•i mÃ¡y:

DNS Ä‘á»•i â†’ app tá»± reconnect

Barrier khÃ´ng dá»«ng.

âœ… Offline safety (nÃªn cÃ³ â€“ cá»±c thá»±c táº¿)

Náº¿u máº¥t DB táº¡m thá»i:

Gate lÆ°u local:

local_queue.json

Sau khi DB online:

sync láº¡i API

=> Barrier váº«n má»Ÿ bÃ¬nh thÆ°á»ng.

ğŸ§© Kiáº¿n trÃºc code cuá»‘i cÃ¹ng cho KHA-PARKING
Camera ANPR
      â†“
Gate PC (Laravel Client)
      â†“ API
Central Laravel Logic
      â†“
SQL Server PRIMARY
      â†“
Realtime Sync Replica
â­ Checklist IMPLEMENT cho báº¡n
Backend

 API vehicle-in

 API vehicle-out

 DB transaction lock

 unique active session

Database

 Unique index active vehicle

 Status IN/OUT rÃµ rÃ ng

 Always write via API

Infrastructure

 3 mÃ¡y cáº¥u hÃ¬nh giá»‘ng nhau

 SQL replication / mirroring

 DB hostname (khÃ´ng dÃ¹ng IP)

ğŸ”¥ Má»™t cÃ¢u tÃ³m gá»n (Ä‘Ãºng báº£n cháº¥t há»‡ thá»‘ng báº¡n tháº¥y ngoÃ i Ä‘á»i)

KhÃ´ng pháº£i nhiá»u mÃ¡y cháº¡y nhiá»u database.
MÃ  nhiá»u mÃ¡y cÃ¹ng phá»¥c vá»¥ má»™t database logic duy nháº¥t cÃ³ kháº£ nÄƒng Ä‘á»•i chá»§.